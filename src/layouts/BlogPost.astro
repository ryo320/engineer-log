---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import Comments from '../components/Comments.astro';
import LikeButton from '../components/LikeButton.astro';

type Props = CollectionEntry<'blog'>['data'] & {
	showComments?: boolean;
};

const { title, description, pubDate, updatedDate, heroImage, showComments = true } = Astro.props;

const url = Astro.url.href;
const id = Astro.url.pathname;

// About Me ページかどうかを判定（重複防止）
const isAboutPage = title === "About Me";
---

<html lang="ja"> 
	<head>
		<BaseHead title={title} description={description} />
		<style is:global>
			:root {
				font-size: clamp(15px, 0.4vw + 13.5px, 18px);
				--accent-blue: #0071e3;
				--apple-black: #1d1d1f;
			}

			main { width: calc(100% - 2em); max-width: 100%; margin: 0; }
			.hero-image { width: 100%; }
			.hero-image img { display: block; margin: 0 auto; border-radius: 12px; box-shadow: var(--box-shadow); }

			/* ▼▼▼ タイポグラフィ階層と改行ルールの再設計 ▼▼▼ */
			.prose {
				width: 720px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 1em;
				color: #424245;
				font-size: 1.1rem;
				line-height: 1.8;
				/* 日本語の改行を最適化：意味の区切りで改行する */
				word-break: auto-phrase;
				line-break: strict;
				overflow-wrap: break-word;
			}

			/* 本文の段落：末尾に1文字だけ残るのを防ぐ */
			.prose p {
				text-wrap: pretty;
				margin-bottom: 1.5em;
			}

			.title { margin-bottom: 1.5em; padding: 0.5em 0 0 0; text-align: center; }
			
			/* タイトル (h1): 見出しの左右バランスを自動調整 */
			.title h1 {
				margin: 0 0 0.3em 0;
				font-size: 3.2rem;
				font-weight: 900;
				color: var(--apple-black);
				letter-spacing: -0.03em;
				line-height: 1.1;
				text-wrap: balance;
			}

			/* 見出し (h2): セクションの区切り */
			.prose h2 {
				font-size: 2.1rem;
				font-weight: 800;
				color: var(--apple-black);
				margin: 3.5rem 0 1.2rem;
				letter-spacing: -0.02em;
				line-height: 1.3;
				text-wrap: balance;
			}

			/* 小見出し (h3) */
			.prose h3 {
				font-size: 1.5rem;
				font-weight: 700;
				color: var(--apple-black);
				margin: 2.5rem 0 1rem;
				line-height: 1.4;
				text-wrap: balance;
			}

			.like-button-wrapper { display: flex; justify-content: center; margin: 0.2rem 0; }
			.like-button-wrapper :global(.like-container) { margin: 0 !important; gap: 4px !important; }
			.title hr { margin: 0.5rem auto 1.5rem; border: 0; border-top: 1px solid #eee; }

			.date {
				margin-bottom: 0.5em;
				color: rgb(var(--gray));
				font-weight: 500;
			}
			
			.comment-divider {
				border: 0;
				border-top: 1px solid #eee;
				margin: 4rem 0 2rem;
			}

			/* シェアボタンのデザイン */
			.share-trigger {
				position: fixed;
				bottom: 2.5rem;
				right: 2.5rem;
				background: #ffffff;
				color: var(--apple-black);
				border: 2px solid var(--accent-blue);
				padding: 0.9rem 1.6rem;
				border-radius: 99px;
				font-weight: 700;
				display: flex;
				align-items: center;
				gap: 0.7rem;
				cursor: pointer;
				box-shadow: 0 15px 45px rgba(0, 113, 227, 0.15);
				z-index: 100;
				transition: 
					transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
					opacity 0.3s ease-out,
					background 0.3s ease,
					color 0.3s ease;
				will-change: transform, opacity;
			}

			.share-trigger.hidden {
				transform: translateY(120px) scale(0.9);
				opacity: 0;
				pointer-events: none;
			}

			.share-trigger:hover {
				background: var(--accent-blue);
				color: #ffffff;
				transform: scale(1.05) translateY(-5px);
				box-shadow: 0 20px 50px rgba(0, 113, 227, 0.3);
			}

			.share-trigger svg { color: var(--accent-blue); transition: color 0.3s ease; }
			.share-trigger:hover svg { color: #ffffff; }

			@media (max-width: 768px) {
				.title h1 { font-size: 2.2rem; }
				.prose h2 { font-size: 1.7rem; }
				.prose h3 { font-size: 1.3rem; }
				.prose { padding: 0.5em; font-size: 1.05rem; }
				.share-trigger { bottom: 1.5rem; right: 1.5rem; padding: 0.8rem 1.3rem; font-size: 0.9rem; }
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article data-pagefind-body>
				<div class="hero-image">
					{heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
				</div>
				<div class="prose">
					<div class="title">
						<div class="date"><FormattedDate date={pubDate} /></div>
						<h1>{title}</h1>
						<div class="like-button-wrapper"><LikeButton slug={id} /></div>
						<hr />
					</div>
					<slot />
				</div>
			</article>

			{showComments && (
				<div class="prose">
					<hr class="comment-divider" />
					<section>
						<h3 style="margin-bottom: 1.5rem;">Comments</h3>
						<Comments title={title} id={id} url={url} />
					</section>
				</div>
			)}
		</main>

		{!isAboutPage && (
			<button id="scroll-share-btn" class="share-trigger" onclick="sharePage()">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
				<span>Share</span>
			</button>
		)}

		<Footer />

		<script is:inline>
			function sharePage() {
				const title = document.title;
				const text = `Engineer Log\n${title}`;
				if (navigator.share) {
					navigator.share({ title, text, url: window.location.href });
				} else {
					navigator.clipboard.writeText(window.location.href);
					alert("リンクをコピーしました！");
				}
			}

			let lastScrollY = window.scrollY;
			let ticking = false;
			const shareBtn = document.getElementById('scroll-share-btn');

			if (shareBtn) {
				window.addEventListener('scroll', () => {
					if (!ticking) {
						window.requestAnimationFrame(() => {
							const currentScrollY = window.scrollY;
							if (currentScrollY > lastScrollY && currentScrollY > 100) {
								shareBtn.classList.add('hidden');
							} else {
								shareBtn.classList.remove('hidden');
							}
							lastScrollY = currentScrollY;
							ticking = false;
						});
						ticking = true;
					}
				}, { passive: true });
			}
		</script>
	</body>
</html>
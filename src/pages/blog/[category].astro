---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, CATEGORIES } from '../../consts';
import { getCollection } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  return CATEGORIES.map((cat) => ({
    params: { category: cat.slug },
    props: { categoryData: cat }, 
  }));
}

const { category } = Astro.params;
const { categoryData } = Astro.props;

// 記事を取得して「このカテゴリのものだけ」に絞り込み、新しい順に並べる
const allPosts = await getCollection('blog');
const filteredPosts = allPosts
  .filter((post) => post.data.category === category)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const pageTitle = `${categoryData.label} | ${SITE_TITLE}`;
---

<!doctype html>
<html lang="ja">
	<head>
		<BaseHead title={pageTitle} description={categoryData.description} />
		<style>
			/* デザイン部分は以前のものをそのまま維持 */
			:root { --accent: #0984e3; --accent-gradient: linear-gradient(45deg, #0984e3, #6c5ce7); }
			main { width: 960px; max-width: calc(100% - 2em); margin: auto; padding: 3em 1em; }
			.category-nav { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 3rem; justify-content: center; border-bottom: 1px solid #eee; padding-bottom: 1.5rem; }
			.cat-link { text-decoration: none; padding: 0.5rem 1.2rem; border-radius: 50px; font-size: 0.95rem; font-weight: 600; color: #636e72; background: #f4f7f6; transition: all 0.3s; }
			.cat-link.active { background: var(--accent-gradient); color: white; }
			ul { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem; list-style-type: none; padding: 0; }
			li { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); transition: 0.3s; }
			li:hover { transform: translateY(-5px); }
			li a { display: block; text-decoration: none; color: inherit; padding: 1.5rem; }
			.hero-image { width: 100%; height: 180px; object-fit: cover; }
		</style>
	</head>
	<body>
		<Header />
		<main>
			<nav class="category-nav">
				<a href="/blog/" class="cat-link">All Posts</a>
				{CATEGORIES.map((cat) => (
					<a href={`/blog/${cat.slug}`} class={`cat-link ${category === cat.slug ? 'active' : ''}`}>{cat.label}</a>
				))}
			</nav>

			<ul>
				{filteredPosts.length > 0 ? (
					filteredPosts.map((post) => (
						<li>
							<a href={`/blog/${post.slug}/`}>
								{post.data.heroImage && <Image width={720} height={360} src={post.data.heroImage} alt="" class="hero-image" />}
								<h4 style="margin-top:1rem;">{post.data.title}</h4>
								<p style="color:#666; font-size:0.9rem;"><FormattedDate date={post.data.pubDate} /></p>
							</a>
						</li>
					))
				) : (
					<p style="text-align:center; grid-column: 1/-1;">まだ記事がありません。</p>
				)}
			</ul>
		</main>
		<Footer />
	</body>
</html>